generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

model Education {
  id             String  @id @default(cuid())
  resumeId       String  @map("resume_id")
  school_name    String
  major          String
  degree         String
  start_date     String
  end_date       String
  order          Int     @default(0)
  degree_en      String?
  major_en       String?
  school_name_en String?
  resume         Resume  @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("educations")
}



model Resume {
  id                String             @id @default(cuid())
  userId            String             @map("user_id")
  title             String
  original_file_url String
  target_role       String?
  status            ResumeStatus       @default(IDLE)
  failure_message   String?
  current_step      ResumeStep         @default(UPLOAD)
  selected_template ResumeTemplate?
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  email             String?
  links             Json?
  name_en           String?
  name_kr           String             @default("")
  phone             String?
  summary           String?            @default("")
  summary_kr        String?            @default("")
  additionalItems   AdditionalItem[]
  educations        Education[]
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills            Skill[]
  work_experiences  WorkExperience[]

  @@map("resumes")
}

model Session {
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Skill {
  id       String  @id @default(cuid())
  resumeId String  @map("resume_id")
  name     String
  level    String?
  order    Int     @default(0)
  resume   Resume  @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("skills")
}



model UsageLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  amount      Float
  description String
  created_at  DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("usage_logs")
}

model PaymentHistory {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  paymentId        String   @unique @map("payment_id")
  orderName        String   @map("order_name")
  amount           Float
  currency         String   @default("KRW")
  status           String
  method           String?
  paidAt           DateTime @default(now()) @map("paid_at")
  receiptUrl       String?  @map("receipt_url")
  initialCredits   Int      @default(0) @map("initial_credits")
  remainingCredits Int      @default(0) @map("remaining_credits")
  details          Json?
  purchaseLocale   String?  @default("ko") @map("purchase_locale") // ğŸ†• êµ¬ë§¤ ë‹¹ì‹œ ì–¸ì–´
  
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_histories")
}

model User {
  id               String             @id @default(cuid())
  name             String?
  email            String             @unique
  emailVerified    DateTime?
  image            String?
  phone_number     String?
  linkedin_url     String?
  portfolio_url    String?
  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt
  
  // ê¸°ê°„ì œ ì´ìš©ê¶Œ í•„ë“œ
  planType         String             @default("FREE") @map("plan_type") // 'FREE', 'PASS_7DAY', 'PASS_30DAY'
  planExpiresAt    DateTime?          @map("plan_expires_at") // Nullì´ë©´ ë§Œë£Œë¨/Free
  credits          Int                @default(10) // í¬ë ˆë”§ ì§€ê°‘
  
  accounts         Account[]
  resumes          Resume[]
  globalResumes    GlobalResume[]  // ğŸ†• ë‹¤êµ­ì–´ ì´ë ¥ì„œ
  sessions         Session[]
  usage_logs       UsageLog[]
  paymentHistories PaymentHistory[]
  feedbacks        Feedback[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

model WorkExperience {
  id              String  @id @default(cuid())
  resumeId        String  @map("resume_id")
  company_name_kr String
  company_name_en String?
  role_kr         String
  role_en         String?
  start_date      String
  end_date        String
  bullets_kr      Json
  bullets_en      Json?
  order           Int     @default(0)
  resume          Resume  @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("work_experiences")
}

model AdditionalItem {
  id             String   @id @default(cuid())
  resumeId      String   @map("resume_id")
  type           ItemType @default(OTHER)
  name_kr        String
  name_en        String?
  description_kr String?  @default("")
  description_en String?  @default("")
  date           String?
  order          Int      @default(0)
  resume        Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("additional_items")
}

enum ResumeStatus {
  IDLE
  PROCESSING
  COMPLETED
  FAILED
}

enum ResumeStep {
  UPLOAD
  PROCESSING
  EDIT
  TEMPLATE
  COMPLETED
}

enum ResumeTemplate {
  MODERN
  CLASSIC
  MINIMAL
  PROFESSIONAL
  EXECUTIVE
}


enum ItemType {
  CERTIFICATION
  AWARD
  LANGUAGE
  ACTIVITY
  OTHER
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  content   String
  rating    Int
  pageUrl   String?  @map("page_url")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("feedbacks")
}

// ============================================
// ğŸ†• ë‹¤êµ­ì–´ ì „ìš© í…Œì´ë¸” (Global Resume Tables)
// ============================================

model GlobalResume {
  id                String              @id @default(cuid())
  userId            String              @map("user_id")

  // ì–¸ì–´ ì •ë³´
  sourceLocale      String              // 'en', 'ja' (ì›ë³¸ ì–¸ì–´)
  detectedLocale    String?             @map("detected_locale") // AIê°€ ìë™ ê°ì§€í•œ ì–¸ì–´ (ê²€ì¦ìš©)
  targetLocale      String              @default("ko") @map("target_locale") // ëª©í‘œ ì–¸ì–´ (í•­ìƒ í•œêµ­ì–´)

  // ë©”íƒ€ë°ì´í„°
  title             String
  original_file_url String              @map("original_file_url")
  target_role       String?             @map("target_role")

  // ì›Œí¬í”Œë¡œìš° ìƒíƒœ
  status            GlobalResumeStatus  @default(IDLE)
  failure_message   String?             @map("failure_message")
  current_step      GlobalResumeStep    @default(UPLOAD) @map("current_step")
  selected_template GlobalResumeTemplate? @map("selected_template")

  // íƒ€ì„ìŠ¤íƒ¬í”„
  created_at        DateTime            @default(now()) @map("created_at")
  updated_at        DateTime            @updatedAt @map("updated_at")

  // ê°œì¸ ì •ë³´
  email             String?
  phone             String?
  links             Json?               // { linkedin, github, portfolio }

  // ì´ë¦„ (ì›ë³¸ ì–¸ì–´ + í•œêµ­ì–´ ë²ˆì—­)
  name_original     String              @map("name_original")
  name_translated   String?             @map("name_translated") // AI ë²ˆì—­ëœ í•œêµ­ì–´ ì´ë¦„

  // ìš”ì•½ (ì›ë³¸ ì–¸ì–´ + í•œêµ­ì–´ ë²ˆì—­)
  summary_original  String?             @default("") @map("summary_original")
  summary_translated String?            @default("") @map("summary_translated")

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  work_experiences  GlobalWorkExperience[]
  educations        GlobalEducation[]
  skills            GlobalSkill[]
  additionalItems   GlobalAdditionalItem[]

  @@index([userId, sourceLocale])
  @@map("global_resumes")
}

model GlobalWorkExperience {
  id              String        @id @default(cuid())
  resumeId        String        @map("resume_id")

  // íšŒì‚¬ëª… (ì›ë³¸ + ë²ˆì—­)
  company_name_original    String  @map("company_name_original")
  company_name_translated  String? @map("company_name_translated")

  // ì—­í•  (ì›ë³¸ + ë²ˆì—­)
  role_original     String  @map("role_original")
  role_translated   String? @map("role_translated")

  // ê¸°ê°„
  start_date        String  @map("start_date")
  end_date          String  @map("end_date")

  // ì—…ë¬´ ë‚´ìš© (ì›ë³¸ + ë²ˆì—­)
  bullets_original     Json  @map("bullets_original")     // ["Developed...", "Led..."]
  bullets_translated   Json? @map("bullets_translated")   // ["ê°œë°œí–ˆìŠµë‹ˆë‹¤...", "ë¦¬ë“œí–ˆìŠµë‹ˆë‹¤..."]

  order             Int     @default(0)
  resume            GlobalResume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("global_work_experiences")
}

model GlobalEducation {
  id             String        @id @default(cuid())
  resumeId       String        @map("resume_id")

  // í•™êµëª… (ì›ë³¸ + ë²ˆì—­)
  school_name_original    String  @map("school_name_original")
  school_name_translated  String? @map("school_name_translated")

  // ì „ê³µ (ì›ë³¸ + ë²ˆì—­)
  major_original     String  @map("major_original")
  major_translated   String? @map("major_translated")

  // í•™ìœ„ (ì›ë³¸ + ë²ˆì—­)
  degree_original    String  @map("degree_original")
  degree_translated  String? @map("degree_translated")

  // ê¸°ê°„
  start_date         String  @map("start_date")
  end_date           String  @map("end_date")

  order              Int     @default(0)
  resume             GlobalResume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("global_educations")
}

model GlobalSkill {
  id       String        @id @default(cuid())
  resumeId String        @map("resume_id")

  // ìŠ¤í‚¬ëª… (ì›ë³¸, ë²ˆì—­ ë¶ˆí•„ìš” - ê¸°ìˆ  ìš©ì–´ëŠ” ê·¸ëŒ€ë¡œ)
  name     String
  level    String?       // 'BEGINNER', 'INTERMEDIATE', 'ADVANCED', 'EXPERT'

  order    Int           @default(0)
  resume   GlobalResume  @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("global_skills")
}

model GlobalAdditionalItem {
  id             String        @id @default(cuid())
  resumeId       String        @map("resume_id")
  type           ItemType      @default(OTHER) // ê¸°ì¡´ enum ì¬ì‚¬ìš©

  // ì´ë¦„ (ì›ë³¸ + ë²ˆì—­)
  name_original     String   @map("name_original")
  name_translated   String?  @map("name_translated")

  // ì„¤ëª… (ì›ë³¸ + ë²ˆì—­)
  description_original    String?  @default("") @map("description_original")
  description_translated  String?  @default("") @map("description_translated")

  date           String?
  order          Int        @default(0)
  resume         GlobalResume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@map("global_additional_items")
}

// ë‹¤êµ­ì–´ ì „ìš© Enum
enum GlobalResumeStatus {
  IDLE
  PROCESSING
  COMPLETED
  FAILED
}

enum GlobalResumeStep {
  UPLOAD
  PROCESSING
  EDIT_TRANSLATION // ë²ˆì—­ í™•ì¸/ìˆ˜ì •
  TEMPLATE
  COMPLETED
}

enum GlobalResumeTemplate {
  MODERN
  CLASSIC
  MINIMAL
  PROFESSIONAL
  EXECUTIVE
}



